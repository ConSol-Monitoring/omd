From e52677d3994d35197db68120d7089906a174a3f9 Mon Sep 17 00:00:00 2001
From: Sven Nierlein <sven@consol.de>
Date: Wed, 31 May 2023 14:39:58 +0200
Subject: [PATCH] check_load: add scaled load if available

---
 share/pnp/templates.dist/check_load.php | 41 ++++++++++++++++++++++---
 1 file changed, 36 insertions(+), 5 deletions(-)

diff --git a/share/pnp/templates.dist/check_load.php b/share/pnp/templates.dist/check_load.php
index c3b46af..8375d70 100644
--- a/share/pnp/templates.dist/check_load.php
+++ b/share/pnp/templates.dist/check_load.php
@@ -1,21 +1,32 @@
 <?php
 #
 # Copyright (c) 2006-2010 Joerg Linge (http://www.pnp4nagios.org)
+# Copyright (c) 2023-2023 Sven Nierlein
 # Plugin: check_load
 #
 $opt[1] = "--vertical-label Load -l0  --title \"CPU Load for $hostname / $servicedesc\" ";
 #
 #
 #
-$def[1]  = rrd::def("var1", $RRDFILE[1], $DS[1], "AVERAGE");
-$def[1] .= rrd::def("var2", $RRDFILE[2], $DS[2], "AVERAGE");
-$def[1] .= rrd::def("var3", $RRDFILE[3], $DS[3], "AVERAGE");
+$def[1]  = "";
+foreach($this->DS as $k=>$v) {
+    if($v['LABEL'] === "load1")  { $def[1] .= rrd::def("var1", $v["RRDFILE"], $v["DS"], "AVERAGE"); }
+    if($v['LABEL'] === "load5")  { $def[1] .= rrd::def("var2", $v["RRDFILE"], $v["DS"], "AVERAGE"); }
+    if($v['LABEL'] === "load15") { $def[1] .= rrd::def("var3", $v["RRDFILE"], $v["DS"], "AVERAGE"); }
+
+    if($v['LABEL'] === "scaled_load1")  {
+        $def[] = "";
+        $def[2] .= rrd::def("var1", $v["RRDFILE"], $v["DS"], "AVERAGE");
+    }
+    if($v['LABEL'] === "scaled_load5")  { $def[2] .= rrd::def("var2", $v["RRDFILE"], $v["DS"], "AVERAGE"); }
+    if($v['LABEL'] === "scaled_load15") { $def[2] .= rrd::def("var3", $v["RRDFILE"], $v["DS"], "AVERAGE"); }
+}
 
 if ($WARN[1] != "") {
-    $def[1] .= "HRULE:$WARN[1]#FFFF00 ";
+   $def[1] .= "HRULE:$WARN[1]#FFFF00 ";
 }
 if ($CRIT[1] != "") {
-    $def[1] .= "HRULE:$CRIT[1]#FF0000 ";       
+   $def[1] .= "HRULE:$CRIT[1]#FF0000 ";
 }
 $def[1] .= rrd::area("var3", "#ff0000", "load 15") ;
 $def[1] .= rrd::gprint("var3", array("LAST", "AVERAGE", "MAX"), "%6.2lf");
@@ -23,4 +34,24 @@ $def[1] .= rrd::area("var2", "#EA8F00", "Load 5 ") ;
 $def[1] .= rrd::gprint("var2", array("LAST", "AVERAGE", "MAX"), "%6.2lf");
 $def[1] .= rrd::area("var1", "#EACC00", "load 1 ") ;
 $def[1] .= rrd::gprint("var1", array("LAST", "AVERAGE", "MAX"), "%6.2lf");
+
+# add scaled load if available
+if(count($def) == 2) {
+    $opt[] = "--vertical-label \"Scaled Load\" -l0  --title \"Scaled CPU Load for $hostname / $servicedesc\" ";
+    $WARN[] = "";
+    $CRIT[] = "";
+    if ($WARN[2] != "") {
+       $def[2] .= "HRULE:$WARN[2]#FFFF00 ";
+    }
+    if ($CRIT[2] != "") {
+       $def[2] .= "HRULE:$CRIT[2]#FF0000 ";
+    }
+    $def[2] .= rrd::area("var3", "#ff0000", "load 15") ;
+    $def[2] .= rrd::gprint("var3", array("LAST", "AVERAGE", "MAX"), "%6.2lf");
+    $def[2] .= rrd::area("var2", "#EA8F00", "Load 5 ") ;
+    $def[2] .= rrd::gprint("var2", array("LAST", "AVERAGE", "MAX"), "%6.2lf");
+    $def[2] .= rrd::area("var1", "#EACC00", "load 1 ") ;
+    $def[2] .= rrd::gprint("var1", array("LAST", "AVERAGE", "MAX"), "%6.2lf");
+}
+
 ?>
-- 
2.39.2

